<!DOCTYPE html>
<html>
<head>
  <title>Face ID ç™»å…¥</title>
</head>
<body>
  <h2>Face ID ç™»å…¥</h2>
  <video id="video" width="320" height="240" autoplay></video>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
  <br>
  <button onclick="captureAndLogin()">Face ID Login</button>

  <script>
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        document.getElementById('video').srcObject = stream;
      })
      .catch(err => {
        alert("ç›¸æ©ŸéŒ¯èª¤ï¼š" + err);
      });
  
    function captureAndLogin() {
      const canvas = document.getElementById('canvas');
      const video = document.getElementById('video');
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
  
      canvas.toBlob(blob => {
        if (!blob) {
          console.error("â— ç„¡æ³•æ“·å–å½±åƒï¼ˆblob ç‚º nullï¼‰");
          alert("âš ï¸ æ“·å–å½±åƒå¤±æ•—ï¼");
          return;
        }
  
        console.log("âœ… æ“·å–å½±åƒæˆåŠŸï¼Œå¤§å°ï¼š" + blob.size + " bytes");
        console.log(blob);  // ğŸ‘‰ é€™ä¸€è¡Œæ˜¯é—œéµ
  
        const formData = new FormData();
        formData.append('image', blob, 'capture.jpg');
  
        fetch('http://localhost/jb_project/face_login_project/face_login_api.php', {
          method: 'POST',
          body: formData
        })
        .then(response => response.text())  // ç”¨ text() å…ˆæ¥èµ·ä¾†çœ‹å®Œæ•´å…§å®¹
        .then(text => {
          console.log("ğŸ“¥ Server Response (åŸå§‹æ–‡å­—):", text);

          try {
            const data = JSON.parse(text);
            console.log('âœ”ï¸ å·²æˆåŠŸé€²å…¥ JSON è™•ç†é‚è¼¯', data);

            if (data.login) {
              console.log('âœ… ç™»å…¥æˆåŠŸï¼Œcid =', data.cid);
              window.location.href = 'm_wallet.php?cid=' + data.cid;
            } else {
              console.warn('âŒ è¾¨è­˜å¤±æ•—ï¼ŒéŒ¯èª¤è³‡è¨Šï¼š', data.error || 'ç„¡');
              alert("è¾¨è­˜å¤±æ•—ï¼š" + (data.error || "ç„¡"));
            }
          } catch (e) {
            console.error("â— JSON è§£æéŒ¯èª¤ï¼š", e);
            alert("âš ï¸ å¾Œç«¯å›å‚³ä¸æ˜¯åˆæ³• JSONï¼Œè«‹é–‹ Console æª¢æŸ¥ Server Responseï¼");
          }
        })
        .catch(err => {
          console.error("âŒ fetch ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
          alert("âš ï¸ ç„¡æ³•è¯ç¹«å¾Œç«¯ï¼š" + err);
        });

      }, 'image/jpeg');
    }
  </script>
  
</body>
</html>
